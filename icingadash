#!/usr/bin/perl -w

use strict;
use warnings;
use Switch;
use Data::Dumper;
use NagiosStatus;

my $boxsize="18px";
my $statusfile="/var/spool/icinga/status.dat";
my $target_url="/icinga/cgi-bin/extinfo.cgi";
my $refresh=5*60; #5 minutes

my $status_object = NagiosStatus->new($statusfile);
$status_object->parse_statusfile();
$status_object->evaluate();

print <<"EOF"
Content-Type: text/html; charset=ISO-8859-1

<html>
    <head>
        <meta http-equiv='refresh' content='$refresh'>
        <style type="text/css">
            .box {
                margin:1px 1px 0px 0px;
                width:$boxsize;
                height:$boxsize;
                text-align:center;
                display:block;
                float:left;
                text-decoration:none;
            }
        </style>
    </head>
<body>
    <h1>Icinga Dashboard</h1>
EOF
;

print "<h2>Host Info</h2>\n";
foreach my $hostname ( keys %{ $status_object->{'HOSTS'}}) {
    my $host=$status_object->{'HOSTS'}->{$hostname} ;
    $hostname=~s/ /+/g;
    my $color="#ffffff";
    switch ($host->{'current_state'}){
        case(0) { $color = "green";  }
        case(1) { $color = "yellow"; }
        case(2) { $color = "red";    
                    if ($host->{'problem_has_been_acknowledged'} == 1 ){$color = "#FF5555"}
                }
        else    { $color = "purple"; }
    }


    print "<a href='$target_url?type=1&host=$hostname' class='box' style='background-color:$color' title='$hostname'></a>";
}

print "<br clear='all'/><h2>Service Info</h2>\n";
foreach my $servicekey ( sort keys %{ $status_object->{'SERVICES'}}) {
    my $service=$status_object->{'SERVICES'}->{$servicekey};
    $servicekey=~s/ /+/g;
    my ($hostname,$servicename)=split /_/,$servicekey;
    my $color="#ffffff";
    switch ($service->{'current_state'}){
        case(0) { $color = "#008000";  }
        case(1) { $color = ($service->{'problem_has_been_acknowledged'} == 1 ) ? "#FFFF55" : "#FFFF00"; }
        case(2) { $color = ($service->{'problem_has_been_acknowledged'} == 1 ) ? "#FF5555" : "#FF0000"; }
        else    { $color = ($service->{'problem_has_been_acknowledged'} == 1 ) ? "#855585" : "#800080"; }
    }
    my $title="$hostname $servicename";
    my $content="&nbsp;";
    if ($service->{'problem_has_been_acknowledged'} == 1 ){
        $content= "&#8730; ";
        my $pluginoutput=$service->{'plugin_output'};
        $pluginoutput=~s/</&lt;/g;
        $pluginoutput=~s/>/&gt;/g;
        $title.="(Acknowledged)\n\n ".$pluginoutput;

    }
    print "<a href='$target_url?type=2&host=$hostname&service=$servicename' class='box' style='background-color:$color;' title=\"$title\">$content</a>";
}
    print "<!--\n";
#    print Dumper $status_object;
    print "-->\n";
print "</body>\n</html>\n";
